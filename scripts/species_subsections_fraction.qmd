---
title: "subsection_species_abundance"
format: pdf
editor: source
---

```{r}
#| echo: false
#| label: data-import
#| output: false

library(tidyverse)
library(ggplot2)
library(ggpmisc)

nero_subsection_species <- readRDS("~/Library/CloudStorage/OneDrive-Aarhusuniversitet/MappingPlants/01 Vegetation changes Kobbefjord/data/nmds_nero/nmds_nero/data/nero_subsection_species.rds")
```

Plots of all species in all vegeation types. 

```{r}
#| label: plot-fractions
#| warning: false
#| echo: false

library(dplyr)
library(ggplot2)
library(broom)    # for tidy()

species_list <- unique(nero_subsection_species$species)

for (sp in species_list) {
  data_sp <- filter(nero_subsection_species, species == sp)
  if (nrow(data_sp) < 2) next
  
  # Calculate p-values for each veg_type
  sig_df <- data_sp %>%
    group_by(veg_type) %>%
    do({
      fit <- lm(fraction ~ year, data = .)
      pval <- glance(fit)$p.value
      tibble(sig = !is.na(pval) && pval < 0.05)
    })
  
  # Merge significance back to data
  data_sp <- left_join(data_sp, sig_df, by = "veg_type")
  
  # Plot: linetype by significance, and use se only for significant lines
  p <- ggplot(data_sp, aes(x = year, y = fraction)) +
    geom_point(size = 3, color = "darkgreen", alpha = 0.6) +
    geom_smooth(
      method = "lm",
      aes(linetype = sig, color = sig),
      se = FALSE  # turn off default shading
    ) +
    # add shaded SE only for sig = TRUE
    geom_smooth(
      data = filter(data_sp, sig),
      method = "lm",
      se = TRUE,
      aes(linetype = sig)
    ) +
    scale_linetype_manual(values = c("FALSE" = "dashed", "TRUE" = "solid")) +
    scale_color_manual(values = c("FALSE" = "darkgray", "TRUE" = "blue")) +
    guides(linetype = "none", color = "none")+
    ylim(0, 1) +
    ggpmisc::stat_poly_eq(
      aes(label = paste(..p.value.label.., ..rr.label.., ..eq.label.., sep = "~~~")),
      formula = y ~ x,
      parse = TRUE
    ) +
    facet_wrap(~veg_type) +
    ggtitle(paste(sp))
  
  print(p)
}
```